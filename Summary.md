本文档主要是总结自己学习CMU15445课程的过程。

## 时间线
学习该课程的主要起因是想做数据库开发的工作，于是通过该课程了解数据库基本知识并积累数据库开发的实践经验。

我是从2023年8月份开始该课程的学习，直到2024年2月初完成了课程的所有项目实践，其中完全投入到CMU15445课程学习的时间大概是30天。

## 课程内容
课程主要分为视频授课与项目实践两部分。项目实践使用的是[2023年春季课程](https://15445.courses.cs.cmu.edu/spring2023/schedule.html)，视频授课使用的是[2022年秋季课程](https://www.youtube.com/playlist?list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf)，不同学期的课程一般只是项目实践的内容可能会不同。

### 视频授课
视频授课的内容主要包括两部分：
1. [《Database System Concepts》](https://www.db-book.com/)中的内容
2. 项目实践相关内容的讲解

主要的项目实践有四个，视频授课的主要内容也可以分成四个部分：
1. 数据存储与缓存：数据库底层存储，slotted页面和log结构存储；数据库的负载类型（OLAP、OLTP），元组的NSM和DSM存储模型，数据压缩；**数据库页面缓冲池**，不使用OS memory mapped io，各种缓冲池优化技术。
2. 索引：哈希索引；**B+树索引**，主要包括原理、各种操作、优化以及并发索引访问。
3. 查询计划生成与优化：查询计划执行的流水线模型；**几类主要的执行器及其不同实现**，数据扫描执行器（顺序扫描、索引扫描等）、join执行器（nested loop join、sort-merge join、hash join）、排序执行器（外部归并排序、堆排序）、聚合执行器（通过排序或哈希找到符合条件的元组后再计算）、limit执行器；查询计划优化，**基于规则**或基于代价。
4. 并发访问控制：事务的ACID、**隔离级别**、**2PL**、OCC、时间戳排序协议、MVCC。

### 项目实践
#### P0 - C++ Primer
这个项目的主要目的是检验C++的学习情况。2023年春季课程是实现一个copy-on-write的前缀树。

难点：熟悉智能指针的使用

#### P1 - Buffer Pool
实现一个页面缓冲池管理器，负责数据库物理页面在磁盘和内存间的换入与换出。具体分成以下三个任务：
1. LRU-K替换策略；
2. 缓冲池管理器：缓冲池分为很多个页框，基于LRU-K策略控制物理页面在缓冲池的换入与换出；
3. 页面的读写Guard：类似C++的lock_guard，便于页面并发访问控制程序的编写。

难点：与MIT6.824不同，本课程的测试用例提供不全。学生只能通过在[GradeScope](https://www.gradescope.com/courses/500628)提交项目代码来检查代码的正确性，如果提交结果不正确，那么学生需要自己新增用例来找出代码的BUG。

#### P2 - B+Tree
实现一个支持并发访问的B+树，支持并发的插入、删除、查找与范围查询。

难点：插入与删除可能会造成B+树节点的分裂与合并（可能是访问路径上的多个节点的分裂与合并）；使用Latch Crabbing悲观锁支持并发读写

#### P3 - Query Execution
实现SeqScan、IndexScan、Aggregation、NestedLoopJoin、HashJoin、Sort、Limit等执行器；实现优化规则：使用HashJoin优化NestedLoopJoin，使用Top-N（堆排序）优化Sort+Limit。

难点：无（只需要了解执行计划执行的流水线模型，然后参照已有的执行器与优化规则的实现即可完成项目的任务）

#### P4 - Concurrency Control
支持事务的并发执行以及不同隔离级别（使用2PL）。主要包括下面几个任务：
1. 锁管理器：支持两类锁，表锁以及行锁（内部使用了意向锁）
2. 死锁检测与恢复：一个线程会周期性的检查（基于锁管理器的数据）是否存在死锁，如果检测到死锁，那么让死锁相关的事务中ID最小的事务回滚
3. 执行计划并发：主要是修改了少数几个执行器的代码，增加了从锁管理器获取和释放锁的代码

难点：在不同隔离级别下，锁授予与释放的逻辑有差别；意向锁的使用；死锁检测

## 总结
通过课程的项目实践，了解了数据库开发的部分内容，但是对部分内容的了解不够深入（比如执行计划生成与优化、并发访问控制协议等），并且很多功能的实现只是采用了最简单的方案（悲观锁）。后续还需要通过阅读论文和工业数据库代码来加深对数据库各部分的认识。